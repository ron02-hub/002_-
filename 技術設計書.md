# EV走行音アンケートアプリケーション 技術設計書

**プロジェクト名**: EV走行音アンケートアプリケーション  
**バージョン**: 1.0.0  
**作成日**: 2026-01-01  
**最終更新日**: 2026-01-01

---

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Client Layer                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│   │   回答者用      │    │   管理者用      │    │   分析者用      │   │
│   │   Web App       │    │   Dashboard     │    │   Dashboard     │   │
│   │   (Next.js)     │    │   (Next.js)     │    │   (Next.js)     │   │
│   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘   │
│            │                      │                      │             │
└────────────┼──────────────────────┼──────────────────────┼─────────────┘
             │                      │                      │
             └──────────────────────┼──────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           API Layer                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     Next.js API Routes                          │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │   │
│   │   │ /survey  │  │ /media   │  │ /analysis│  │ /admin   │       │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                    │
│                     ┌──────────────┼──────────────┐                    │
│                     ▼              ▼              ▼                    │
│              ┌────────────┐ ┌────────────┐ ┌────────────┐              │
│              │   Prisma   │ │ Media      │ │ Python     │              │
│              │   ORM      │ │ Player     │ │ Analysis   │              │
│              └────────────┘ └────────────┘ └────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           Data Layer                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│   │   PostgreSQL    │    │   File System   │    │   Local Storage │   │
│   │   (Supabase)   │    │   (Media Files) │    │   (Session)     │   │
│   └─────────────────┘    └─────────────────┘    └─────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 レイヤー構成

#### プレゼンテーション層（Client Layer）
- **Next.js 14 App Router**: サーバーサイドレンダリングとクライアントサイドレンダリングのハイブリッド
- **React 18**: UIコンポーネント構築
- **TypeScript**: 型安全性の確保

#### アプリケーション層（API Layer）
- **Next.js API Routes**: RESTful APIエンドポイント
- **Prisma ORM**: データベースアクセス
- **Python Scripts**: 分析処理（NLP、統計解析）

#### データ層（Data Layer）
- **PostgreSQL**: 主要データベース（Supabase）
- **File System**: メディアファイル保存
- **Local Storage**: セッション管理

---

## 2. 技術スタック

### 2.1 フロントエンド

| カテゴリ | 技術 | バージョン | 選定理由 |
|----------|------|-----------|----------|
| フレームワーク | Next.js | 14.x | SSR/SSG対応、API Routes一体型 |
| 言語 | TypeScript | 5.x | 型安全性、開発効率 |
| スタイリング | Tailwind CSS | 3.x | ユーティリティファースト、カスタマイズ性 |
| UIコンポーネント | shadcn/ui | latest | アクセシビリティ、カスタマイズ可能 |
| 状態管理 | Zustand | 4.x | シンプル、TypeScript親和性 |
| フォーム | React Hook Form + Zod | - | バリデーション、型安全 |
| 音声再生 | Howler.js | 2.x | クロスブラウザ対応、Web Audio API |
| 動画再生 | HTML5 Video | - | ネイティブサポート、パフォーマンス |
| メディア統合 | MediaPlayer | - | 音声・動画の自動判定と統合再生 |
| 可視化 | D3.js + Recharts | - | カスタム可視化 + グラフ |
| アニメーション | Framer Motion | 10.x | 滑らかなUI遷移 |

### 2.2 バックエンド

| カテゴリ | 技術 | バージョン | 選定理由 |
|----------|------|-----------|----------|
| API | Next.js API Routes | 14.x | フロントエンドと一体型 |
| ORM | Prisma | 5.x | 型安全、マイグレーション |
| 認証 | NextAuth.js | 5.x | OAuth対応、セッション管理（将来的に拡張） |
| バリデーション | Zod | 3.x | ランタイム型チェック |

### 2.3 データベース・ストレージ

| カテゴリ | 技術 | バージョン | 選定理由 |
|----------|------|-----------|----------|
| データベース | PostgreSQL | 14+ | リレーショナルデータ、Supabase対応 |
| クラウドDB | Supabase | - | 管理不要、スケーラブル |
| ファイルストレージ | File System | - | ローカル開発、将来的にCloudflare R2へ移行可能 |
| 動画ファイル | ローカルFS | - | `/Users/ry/Documents/06_Cursor/999_data/Movie` |
| 音声テスト | ローカルFS | - | `/Users/ry/Documents/06_Cursor/999_data/Sound_data/999_AudioTest` |

### 2.4 分析・処理

| カテゴリ | 技術 | バージョン | 選定理由 |
|----------|------|-----------|----------|
| 言語 | Python | 3.11+ | データ分析ライブラリが豊富 |
| NLP | MeCab | - | 日本語形態素解析 |
| NLP | Transformers | - | BERT感情分析 |
| 統計解析 | scikit-learn | - | 因子分析、クラスター分析 |
| 価値予測 | statsmodels | - | 重回帰分析による購買意欲寄与度の算出 |
| データ処理 | pandas | - | データ操作 |
| 可視化 | matplotlib | - | グラフ生成 |

---

## 3. データモデル設計

### 3.1 データベーススキーマ

#### User（回答者）
```prisma
model User {
  id                String    @id @default(uuid())
  ageGroup          String
  gender            String?
  region            String?
  drivingExperience Int?
  evOwnership       Boolean?
  audioSensitivity  Int?
  experimentGroup   String?   // A/Bテスト用
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  surveys           Survey[]
}
```

#### Survey（アンケートセッション）
```prisma
model Survey {
  id            String    @id @default(uuid())
  userId        String
  sessionId     String    @unique
  phase         String
  startTime     DateTime
  endTime       DateTime?
  isCompleted   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id])
  evaluations   Evaluation[]
  constructs    Construct[]
  interviews    Interview[]
}
```

#### AudioSample（音声・動画サンプル）
```prisma
model AudioSample {
  id          String    @id @default(uuid())
  name        String
  description String?
  fileUrl     String
  duration    Int?
  category    String?
  metadata    Json?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  evaluations Evaluation[]
}
```

#### Evaluation（評価）
```prisma
model Evaluation {
  id            String    @id @default(uuid())
  surveyId      String
  audioSampleId String
  sdScores      Json      // SD法スコア（9軸）
  purchaseIntent Int?
  willingnessToPay Int?   // 追加支払可能額 (WTP)
  purchaseIntentConditions Json? // 提示した条件（N-Box, 200万等）
  freeText      String?
  createdAt     DateTime  @default(now())
  
  survey        Survey    @relation(fields: [surveyId], references: [id])
  audioSample   AudioSample @relation(fields: [audioSampleId], references: [id])
}
```

#### Construct（コンストラクト）
```prisma
model Construct {
  id              String    @id @default(uuid())
  surveyId        String
  bestAudioId     String?   // 最も良かった音
  worstAudioId    String?   // 最も悪かった音
  bestReason      String?   // 良かった理由
  worstReason     String?   // 悪かった理由
  ladderUp        Json?     // 上位概念
  ladderDown      Json?      // 下位概念
  createdAt       DateTime  @default(now())
  
  survey          Survey    @relation(fields: [surveyId], references: [id])
}
```

#### Interview（インタビュー）
```prisma
model Interview {
  id        String    @id @default(uuid())
  surveyId  String
  topic     String
  question  String
  answer    String
  depth     Int       @default(0)
  createdAt DateTime  @default(now())
  
  survey    Survey    @relation(fields: [surveyId], references: [id])
}
```

### 3.2 データフロー

```
回答者入力
    ↓
Zustand Store（一時保存）
    ↓
API Route（バリデーション）
    ↓
Prisma ORM（データ変換）
    ↓
PostgreSQL（永続化）
    ↓
分析処理（Python）
    ↓
可視化（D3.js/Recharts）
```

---

## 4. API設計

### 4.1 回答者向けAPI

#### POST /api/survey/start
- **説明**: アンケートセッション開始
- **リクエスト**: `{ experimentGroup?: string }`
- **レスポンス**: `{ sessionId: string, audioOrder: string[] }`

#### POST /api/survey/consent
- **説明**: 同意取得
- **リクエスト**: `{ sessionId: string, consent: boolean }`
- **レスポンス**: `{ success: boolean }`

#### POST /api/survey/demographics
- **説明**: 属性情報保存
- **リクエスト**: `{ sessionId: string, demographics: {...} }`
- **レスポンス**: `{ success: boolean }`

#### GET /api/audio/samples
- **説明**: 音声・動画サンプル一覧取得
- **レスポンス**: `AudioSample[]`

#### POST /api/survey/evaluation
- **説明**: 評価結果保存
- **リクエスト**: `{ sessionId: string, audioId: string, evaluation: {...} }`
- **レスポンス**: `{ success: boolean }`

#### POST /api/survey/triad
- **説明**: トライアド比較結果保存
- **リクエスト**: `{ sessionId: string, triad: {...} }`
- **レスポンス**: `{ success: boolean }`

#### POST /api/survey/interview
- **説明**: インタビュー回答保存
- **リクエスト**: `{ sessionId: string, interview: {...} }`
- **レスポンス**: `{ success: boolean }`

#### GET /api/media/files/[filename]
- **説明**: メディアファイル配信
- **クエリパラメータ**: 
  - `type`: `movie`（デフォルト）または `audio-test`
- **機能**:
  - Rangeリクエスト対応（ストリーミング再生）
  - ディレクトリトラバーサル対策
  - Content-Type自動判定（MP3, WAV, MP4, WebM, OGG）
- **レスポンス**: メディアファイル（バイナリ、ストリーミング対応）

### 4.2 管理者向けAPI

#### GET /api/admin/responses
- **説明**: 回答データ一覧取得
- **クエリ**: `?page=1&limit=50`
- **レスポンス**: `{ data: Response[], total: number }`

#### GET /api/analysis/sd-scores
- **説明**: SD法スコア集計
- **レスポンス**: `{ scores: {...} }`

#### GET /api/analysis/purchase-intent
- **説明**: 購買意欲分布
- **レスポンス**: `{ distribution: {...} }`

#### GET /api/analysis/value-tree
- **説明**: 価値ツリーデータ生成
- **レスポンス**: `{ tree: {...} }`

#### GET /api/analysis/factor-analysis
- **説明**: 因子分析実行
- **レスポンス**: `{ factors: {...} }`

#### GET /api/admin/export
- **説明**: データエクスポート
- **クエリ**: `?format=csv`
- **レスポンス**: CSVファイル

---

## 5. コンポーネント設計

### 5.1 主要コンポーネント

#### MediaPlayer
- **責務**: 音声・動画の再生制御（統合プレーヤー）
- **技術**: useMediaPlayerフック、useVideoPlayerフック、HTML5 Video/Howler.js
- **Props**: `src`, `title`, `onPlayComplete`, `mediaType` (auto/audio/video), `showVideo`
- **機能**:
  - ファイル拡張子から自動判定（音声/動画）
  - 動画表示オプション（showVideo）
  - コンパクトモード対応
  - エラーハンドリング

#### SDScaleForm
- **責務**: SD法評価入力
- **技術**: React Hook Form、Zod
- **Props**: `onSubmit`, `defaultValues`
- **変更点**: 自然さ軸の追加

#### PurchaseIntentForm
- **責務**: 購買意欲評価入力
- **詳細**: Honda N-Boxの画像、価格、燃費等の前提条件を表示した上で評価を求める

#### LadderingInterface
- **責務**: 最良・最悪音に基づくラダリングUI
- **Props**: `bestAudio`, `worstAudio`, `onSubmit`

#### ChatInterface
- **責務**: デプスインタビューUI
- **技術**: Framer Motion、動的質問生成
- **Props**: `onAnswer`, `initialQuestion`

#### ValueTree
- **責務**: 価値ツリー可視化
- **技術**: D3.js
- **Props**: `data`, `onNodeClick`

### 5.2 状態管理設計

#### Zustand Store構造
```typescript
interface SurveyStore {
  // セッション情報
  sessionId: string | null;
  currentPhase: Phase;
  
  // 音声サンプル
  audioSamples: AudioSample[];
  audioOrder: string[];
  currentAudioIndex: number;
  
  // 評価データ
  evaluations: Map<string, Evaluation>;
  
  // コンストラクト
  constructs: Construct[];
  
  // インタビュー
  interviewHistory: InterviewMessage[];
  
  // Actions
  setAudioSamples: (samples: AudioSample[]) => void;
  addEvaluation: (evaluation: Evaluation) => void;
  // ...
}
```

---

## 6. セキュリティ設計

### 6.1 認証・認可
- **現状**: セッションIDベース（将来的にNextAuth.js導入）
- **管理者認証**: 将来的に実装

### 6.2 データ保護
- **HTTPS**: 本番環境で必須
- **入力検証**: Zodによるバリデーション
- **SQLインジェクション対策**: Prisma ORMによる自動エスケープ
- **XSS対策**: Reactの自動エスケープ

### 6.3 ファイルアクセス
- **ディレクトリトラバーサル対策**: ファイルパスの検証
- **ファイル形式制限**: 許可された拡張子のみ

---

## 7. パフォーマンス設計

### 7.1 最適化戦略
- **コード分割**: Next.jsの自動コード分割
- **画像最適化**: Next.js Imageコンポーネント
- **キャッシング**: メディアファイルのキャッシュ設定
- **遅延読み込み**: 動的インポート

### 7.2 データベース最適化
- **インデックス**: 頻繁に検索されるカラムにインデックス
- **クエリ最適化**: Prismaのクエリ最適化

---

## 8. エラーハンドリング

### 8.1 エラー分類
- **クライアントエラー**: 400系（バリデーションエラーなど）
- **サーバーエラー**: 500系（データベースエラーなど）
- **ネットワークエラー**: タイムアウト、接続エラー

### 8.2 エラー処理
- **ErrorBoundary**: React Error Boundaryによるエラー捕捉
- **ログ記録**: サーバーサイドエラーのログ記録
- **ユーザーフィードバック**: 分かりやすいエラーメッセージ
- **ローディング状態**: 非同期処理中のローディング表示
- **再試行機能**: エラー発生時の再試行ボタン
- **エラー状態管理**: useStateによるエラー状態の管理

---

## 9. テスト戦略

### 9.1 テスト種類
- **ユニットテスト**: Jest + React Testing Library
- **統合テスト**: APIエンドポイントのテスト
- **E2Eテスト**: Playwright（将来的に実装）

### 9.2 テストカバレッジ
- **目標**: 60%以上
- **重点**: ビジネスロジック、APIエンドポイント

---

## 10. デプロイメント設計

### 10.1 環境構成
- **開発環境**: ローカル（localhost:3000）
- **本番環境**: Vercel（推奨）

### 10.2 デプロイフロー
1. GitHubにプッシュ
2. Vercelが自動検知
3. ビルド・デプロイ実行
4. 環境変数の設定

### 10.3 環境変数
- `DATABASE_URL`: PostgreSQL接続文字列
- `NEXTAUTH_SECRET`: 認証用シークレット（将来的に）
- `NEXTAUTH_URL`: 認証用URL（将来的に）

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|----------|--------|
| 2026-01-01 | 1.0.0 | 初版作成 | - |
| 2026-01-04 | 1.1.0 | 評価グリッド法の変更（トライアド→最良・最悪比較）およびSD軸追加に伴うスキーマ・コンポーネント設計の更新 | - |
| 2026-01-05 | 2.5.0 | マーケティング分析レポート生成機能（因子分析・NLP・価値ツリー統合）の技術仕様を確定 | - |

---

## 12. 承認

| 役割 | 名前 | 承認日 | 署名 |
|------|------|--------|------|
| アーキテクト | - | - | - |
| 技術リーダー | - | - | - |

