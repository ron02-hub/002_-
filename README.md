# EV走行音アンケートアプリケーション

🚗 電気自動車（EV）走行音の価値を定量化し、購買意欲を最大化するための戦略的評価システム

## 📋 プロジェクト概要

本プロジェクトは、EV走行音に対するユーザーの深層心理を「音響心理学」「行動経済学」の観点から解析し、次世代EVの市場価値を定量的に向上させるための意思決定支援プラットフォームです。

### 主な特徴

- **価値創造エンジニアリング**: 単なる印象評価を超え、走行音が「購買決定」や「ブランド資産価値」に与える影響を算出
- **最良・最悪対比グリッド法**: ユーザーの理想と現実のギャップを特定し、サウンドデザインの最短経路を導出
- **コンテキスト駆動評価**: 車両スペック（価格・燃費・車種）を前提とした、実購買に近い状況下での意思決定分析
- **デプスインタビュー型UI**: ユーザーの「自分らしさ」と「走行音」の結びつきを探索する対話型インターフェース
- **価値ツリー可視化**: 物理的音響特性から終極的な人生の価値観までの連鎖を構造化

## 🎯 対象ユーザー

- **回答者**: 日本国内の成人（20〜70歳）
- **分析者**: マーケティング担当者、音響エンジニア、製品企画担当者

## 📁 プロジェクト構造

```
002_アンケート/
├── README.md                 # 本ファイル
├── プロンプト.txt            # プロジェクト要件
├── specs/                    # 仕様書（Kiro-style）
│   ├── requirements.md       # 要件定義書
│   ├── design.md             # 設計書
│   ├── architecture.md       # アーキテクチャ設計書
│   └── tasks.md              # タスク一覧
├── docs/                     # ドキュメント
├── src/                      # ソースコード（開発時に作成）
│   ├── app/                  # Next.js App Router
│   ├── components/           # Reactコンポーネント
│   ├── lib/                  # ユーティリティ
│   ├── stores/               # Zustand stores
│   └── styles/               # スタイル
└── analysis/                 # Python分析スクリプト（開発時に作成）
```

## 🛠 技術スタック

### フロントエンド
- Next.js 14 (App Router)
- TypeScript
- Tailwind CSS + shadcn/ui
- Zustand (状態管理)
- Howler.js (音声再生) + HTML5 Video (動画再生)
- MediaPlayer (音声・動画統合プレーヤー)
- D3.js + Recharts (可視化)

### バックエンド
- Next.js API Routes
- Prisma (ORM)
- PostgreSQL (Supabase)

### 分析基盤
- Python 3.11+
- MeCab (形態素解析)
- Transformers (感情分析)
- scikit-learn (機械学習)

## 📊 評価手法

### 1. SD法（Semantic Differential）
7段階スケールで音の印象を多次元評価
- 静か ↔ うるさい
- 心地よい ↔ 不快
- 高級感 ↔ 安っぽい
- 自然 ↔ 人工的（追加）
- など9軸

### 2. 評価グリッド法（Repertory Grid）
全走行音から「最も印象が良い音」と「最も印象が悪い音」を選択・比較し、ユーザー固有の評価軸（コンストラクト）を抽出

### 3. ラダリング
「なぜそれが重要ですか？」を繰り返し、表面的な印象から深層価値へ到達

### 4. デプスインタビュー型質問
AIが動的に質問を生成し、対話形式で深掘り

## 🚀 開発ロードマップ

| フェーズ | 期間 | 内容 | ステータス |
|----------|------|------|-----------|
| Phase 1 | Week 1-2 | 基盤構築（Next.js, DB, 音声再生） | ✅ 完了 |
| Phase 2 | Week 3-5 | コア機能（評価UI, インタビューUI） | ✅ 完了 |
| Phase 3 | Week 6-7 | 分析機能（NLP, 可視化） | ✅ 完了 |
| Phase 4 | Week 8 | 最適化・テスト | ✅ 完了 |
| Phase 5 | 2026-01-04 | データ検証・擬似データ生成 | ✅ 完了 |
| Phase 6 | 2026-01-04 | 動画再生機能の改善・テスト環境整備 | ✅ 完了 |
| Phase 7 | 2026-01-04 | 本番環境準備・音声テスト改善 | ✅ 完了 |
| Phase 8 | 2026-01-04 | パフォーマンス最適化 | ✅ 完了 |
| Phase 9 | 2026-01-04 | E2Eテスト実装 | 🔄 進行中 |

## 📝 仕様書

詳細な仕様は以下のドキュメントを参照してください：

### Kiro形式ドキュメント
- [要件定義書](./要件定義書.md)
- [技術設計書](./技術設計書.md)
- [実装計画書](./実装計画書.md)
- [アンケート設計書](./アンケート設計.md)

### 詳細仕様書（specs/）
- [要件定義書](./specs/requirements.md)
- [設計書](./specs/design.md)
- [アーキテクチャ設計書](./specs/architecture.md)
- [タスク一覧](./specs/tasks.md)
- [改善計画](./specs/improvements.md)
- [テスト結果](./specs/test-results.md)

## 🔧 開発環境セットアップ

### 前提条件
- Node.js 18以上
- npm または yarn
- PostgreSQL（Supabase推奨）

### セットアップ手順

```bash
# 1. リポジトリをクローン（または既存ディレクトリに移動）
cd 002_アンケート

# 2. 依存関係のインストール
cd src
npm install

# 3. 環境変数設定
cp .env.example .env.local
# .env.local を編集してデータベース接続情報を設定

# 4. Prismaクライアント生成
npm run db:generate

# 5. データベースマイグレーション
npm run db:migrate

# 6. シードデータ投入
npm run db:seed

# 7. 開発サーバー起動
npm run dev
```

アプリケーションは [http://localhost:3000](http://localhost:3000) で起動します。

### Python分析環境のセットアップ（オプション）

```bash
cd src/analysis
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

## 📈 成功指標

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| アンケート完了率 | 80%以上 | 完了数 / 開始数 |
| 平均回答時間 | 40〜50分 | 回答時間の平均 |
| 自由記述平均文字数 | 100文字以上/質問 | 文字数の平均 |
| コンストラクト抽出数 | 5個以上/回答者 | トライアド比較結果 |

## ✅ 実装完了機能

### Phase 1: 基盤構築 ✅
- Next.js 14プロジェクト（TypeScript, App Router）
- Prisma + PostgreSQL（Supabase）
- Zustand状態管理
- MediaPlayer（音声・動画統合再生）
- 基本レイアウト・進捗バー
- メディアファイル管理（動画・音声テスト対応）

### Phase 2: コア機能 ✅
- ランディングページ
- 同意・属性入力フォーム
- SD法評価画面（8軸）
- 購買意欲評価
- トライアド比較（評価グリッド法）
- ラダリング機能
- デプスインタビュー型UI（チャット形式）

### Phase 3: 分析機能 ✅
- 価値ツリー可視化（D3.js）
- SD法レーダーチャート
- 購買意欲分布ヒストグラム
- クロス集計テーブル
- 因子分析
- NLP分析（MeCab/BERT対応）
- 管理者ダッシュボード

### Phase 4: 最適化・テスト ✅
- エラーハンドリング（ErrorBoundary）
- ローディング状態管理とエラー表示
- 中断・再開機能
- パフォーマンス最適化（ストリーミング対応）
- Jestテスト環境
- ユニットテスト実装
- テストモード機能（クエリパラメータ対応）

### Phase 5: データ検証・擬似データ生成 ✅
- 200名分の擬似データ生成スクリプト
- データ整合性チェック機能
- 統計分析用データ検証

### Phase 6: 動画再生機能の改善・テスト環境整備 ✅
- useVideoPlayerフックの簡素化
- TestRun.pyスクリプトの作成と改善
- 動画再生問題の解決

### Phase 7: 本番環境準備・音声テスト改善 ✅
- 音声テスト画面の改善（選択肢形式、正解チェック機能）
- 本番環境デプロイ手順書の作成
- 環境変数設定テンプレートの作成

### Phase 8: パフォーマンス最適化 ✅
- 動画再生機能のメモリリーク対策
- CPU使用率の最適化（timeupdateイベントのthrottle）
- パフォーマンス監視ドキュメントの作成

### Phase 9: E2Eテスト実装 🔄
- Playwrightのセットアップ
- ランディングページのE2Eテスト
- アンケートフロー全体のE2Eテスト
- 動画再生機能のE2Eテスト

## 🧪 テスト

### ユニットテスト

```bash
# ユニットテスト実行
npm test

# テストカバレッジ
npm run test:coverage

# ウォッチモード
npm run test:watch
```

### E2Eテスト

```bash
# すべてのE2Eテストを実行
npm run test:e2e

# UIモードで実行（視覚的に確認しながら）
npm run test:e2e:ui

# ヘッドモードで実行（ブラウザを表示）
npm run test:e2e:headed

# デバッグモードで実行
npm run test:e2e:debug
```

詳細は[E2Eテストガイド](./src/docs/e2e-testing.md)を参照してください。

### CI/CD

GitHub Actionsを使用して、プルリクエストとプッシュ時に自動的に以下を実行します：

- **リントとフォーマットチェック**: コードの品質を確認
- **ユニットテスト**: コンポーネントの動作を確認
- **ビルド**: アプリケーションが正常にビルドできることを確認
- **E2Eテスト**: アンケートフロー全体の動作を確認

テスト結果はGitHubのプルリクエストページで確認できます。失敗したテストの詳細、スクリーンショット、動画はアーティファクトからダウンロードできます。

## 📊 主要画面

- `/` - ランディングページ
- `/survey/consent` - 同意画面
- `/survey/demographics` - 属性入力
- `/survey/audio-check` - 音声チェック
- `/survey/evaluation` - 音声評価（SD法）
- `/survey/triad` - トライアド比較
- `/survey/laddering` - ラダリング
- `/survey/interview` - デプスインタビュー
- `/survey/complete` - 完了画面
- `/survey/resume` - 中断したアンケート再開
- `/admin/dashboard` - 管理者ダッシュボード

## 📄 ライセンス

Private - All rights reserved

## 更新履歴

| 日付 | バージョン | 更新内容 |
|------|-----------|----------|
| 2026-01-01 | 0.1.0 | 仕様書作成、プロジェクト初期化 |
| 2026-01-01 | 1.0.0 | Phase 1-4完了、全機能実装完了 |
| 2026-01-01 | 1.1.0 | 音声・動画統合再生対応、エラーハンドリング改善 |
| 2026-01-04 | 1.2.0 | TestRun.pyに基づく設計変更（SD軸、購買意欲、ラダリング、インタビュー）の反映 |
| 2026-01-04 | 1.3.0 | 擬似データ生成機能、データ検証機能の実装 |
| 2026-01-04 | 1.4.0 | 動画再生機能の改善、TestRun.pyの改善 |
| 2026-01-04 | 1.5.0 | 音声テスト画面の改善、本番環境準備ドキュメント作成 |
| 2026-01-04 | 1.6.0 | 本番環境デプロイ手順書完成 |
| 2026-01-04 | 1.7.0 | 動画再生パフォーマンス最適化（メモリリーク対策、CPU使用率最適化） |
| 2026-01-04 | 1.8.0 | E2Eテスト実装（Playwrightセットアップ、アンケートフローテスト、動画再生テスト） |
| 2026-01-05 | 1.9.0 | E2Eテスト修正（テストモード実装、クエリパラメータ継承、テストスクリプト改善） |
| 2026-01-05 | 2.0.0 | CI/CDパイプライン統合（GitHub Actionsワークフロー作成、自動テスト実行） |
| 2026-01-05 | 2.1.0 | アクセシビリティ対応（WCAG 2.1 AA準拠、キーボードナビゲーション、スクリーンリーダー対応） |

